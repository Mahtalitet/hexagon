<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RepositoryPackage.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon</a> &gt; <a href="index.source.html" class="el_package">co.there4.hexagon.repository</a> &gt; <span class="el_source">RepositoryPackage.kt</span></div><h1>RepositoryPackage.kt</h1><pre class="source lang-java linenums">package co.there4.hexagon.repository

import co.there4.hexagon.settings.SettingsManager
import co.there4.hexagon.events.EventManager
import com.mongodb.MongoClient
import com.mongodb.MongoClientURI
import com.mongodb.client.MongoCollection
import com.mongodb.client.MongoDatabase
import org.bson.Document
import org.bson.conversions.Bson
import org.bson.types.ObjectId
import kotlin.reflect.KClass
import kotlin.reflect.KProperty1
import com.mongodb.client.model.Filters.eq as mEq
import com.mongodb.client.model.Filters.or as mOr
import com.mongodb.client.model.Filters.and as mAnd
import com.mongodb.client.model.Filters.`in` as mIn

<span class="pc bpc" id="L19" title="1 of 2 branches missed.">val mongodbUrl = SettingsManager[&quot;mongodbUrl&quot;] as String? ?: &quot;mongodb://localhost/test&quot;</span>

fun mongoDatabase (uri: String = mongodbUrl): MongoDatabase =
<span class="pc bpc" id="L22" title="1 of 2 branches missed.">    MongoClient(MongoClientURI(uri)).getDatabase(MongoClientURI(uri).database) ?:</span>
<span class="pc" id="L23">        error (&quot;Error connecting to MongoDB at: $uri&quot;)</span>

fun mongoCollection (
    name: String, database: MongoDatabase = mongoDatabase()) : MongoCollection&lt;Document&gt; =
<span class="pc bpc" id="L27" title="1 of 2 branches missed.">        database.getCollection(name) ?: error (&quot;Error getting '$name' collection&quot;)</span>

<span class="fc" id="L29">fun mongoId(): String = ObjectId().toHexString()</span>

inline fun &lt;reified T : Any&gt; mongoRepository(
    database: MongoDatabase = mongoDatabase(), publishEvents: Boolean = false) =
<span class="nc bnc" id="L33" title="All 2 branches missed.">        MongoRepository(T::class, mongoCollection(T::class.simpleName ?: error(&quot;&quot;), database), publishEvents )</span>

inline fun &lt;reified T : Any, reified K : Any&gt; mongoIdRepository(
    database: MongoDatabase,
    key: KProperty1&lt;T, K&gt;,
    publishEvents: Boolean = false,
    indexOrder: Int = 1,
    createIndex: Boolean = true) =
<span class="nc bnc" id="L41" title="All 2 branches missed.">    MongoIdRepository (</span>
        T::class,
        mongoCollection(T::class.simpleName ?: error(&quot;Error getting type name&quot;), database),
        key,
        publishEvents,
        indexOrder,
        createIndex
<span class="nc" id="L48">    )</span>

inline fun &lt;reified T : Any, reified K : Any&gt; mongoIdRepository(
    key: KProperty1&lt;T, K&gt;,
    publishEvents: Boolean = false,
    indexOrder: Int = 1,
    createIndex: Boolean = true) =
<span class="nc" id="L55">        mongoIdRepository ( mongoDatabase(), key, publishEvents, indexOrder, createIndex)</span>

<span class="nc" id="L57">infix fun Bson.or(value: Bson): Bson = mOr(this, value)</span>
<span class="nc" id="L58">infix fun Bson.and(value: Bson): Bson = mAnd(this, value)</span>
<span class="fc" id="L59">infix fun &lt;T&gt; String.eq(value: T): Bson = mEq(this, value)</span>
<span class="fc" id="L60">infix fun &lt;T&gt; String.isIn(value: List&lt;T&gt;): Bson = mIn(this, value)</span>

fun &lt;T : Any&gt; on (
    entity: KClass&lt;T&gt;, action: RepositoryEventAction, callback: (RepositoryEvent&lt;T&gt;) -&gt; Unit) {
    @Suppress(&quot;UNCHECKED_CAST&quot;)
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">    EventManager.on (</span>
        RepositoryEvent::class,
        entity.simpleName + &quot;.&quot; + action.toString(),
        callback as (RepositoryEvent&lt;*&gt;) -&gt; Unit
    )
<span class="fc" id="L70">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>