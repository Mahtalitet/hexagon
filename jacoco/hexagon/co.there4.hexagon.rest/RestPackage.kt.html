<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RestPackage.kt</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon</a> &gt; <a href="index.source.html" class="el_package">co.there4.hexagon.rest</a> &gt; <span class="el_source">RestPackage.kt</span></div><h1>RestPackage.kt</h1><pre class="source lang-java linenums">package co.there4.hexagon.rest

import co.there4.hexagon.repository.MongoIdRepository
import co.there4.hexagon.rest.ratpack.KChain
import java.lang.Runtime.getRuntime
import java.lang.String.format
import java.lang.System.currentTimeMillis
import java.lang.System.getProperty
import java.lang.management.ManagementFactory.getMemoryMXBean
import java.lang.management.ManagementFactory.getRuntimeMXBean
import java.net.InetAddress.getLocalHost

import co.there4.hexagon.rest.ratpack.KServerSpec
import co.there4.hexagon.serialization.parse
import co.there4.hexagon.serialization.serialize
import co.there4.hexagon.util.CompanionLogger
import co.there4.hexagon.util.EOL
import co.there4.hexagon.util.filterVars
import com.mongodb.MongoWriteException
import ratpack.handling.Chain
import ratpack.handling.Context
import ratpack.server.RatpackServer
import java.net.UnknownHostException

<span class="fc" id="L25">object RestPackage : CompanionLogger (RestPackage::class)</span>

<span class="pc" id="L27">val information = &quot;&quot;&quot;</span>
    Running in '#{application.host}' with #{application.cpus} CPUs #{application.jvm.memory} KB
    Java #{application.jvm.version} [#{application.jvm}]
    Locale #{application.locale} Timezone #{application.timezone}

    Started in #{application.boot.time} s using #{application.used.memory} KB
    &quot;&quot;&quot;

private fun showBanner() {
<span class="fc" id="L36">    val runtime = getRuntime()</span>
<span class="fc" id="L37">    val heap = getMemoryMXBean().getHeapMemoryUsage()</span>
<span class="fc" id="L38">    val bootTime = currentTimeMillis() - getRuntimeMXBean().getStartTime()</span>

<span class="fc" id="L40">    val locale = &quot;%s_%s.%s&quot;.format(</span>
        getProperty(&quot;user.language&quot;),
        getProperty(&quot;user.country&quot;),
        getProperty(&quot;file.encoding&quot;)
    )
<span class="fc" id="L45">    val hostName = try {</span>
<span class="pc" id="L46">        getLocalHost().getCanonicalHostName()</span>
    }
    catch (e: UnknownHostException) {
<span class="nc" id="L49">        &quot;UNKNOWN&quot;</span>
    }

<span class="fc" id="L52">    val variables = mapOf (</span>
        &quot;application.locale&quot; to locale,
        &quot;application.timezone&quot; to getProperty(&quot;user.timezone&quot;),
        &quot;application.cpus&quot; to runtime.availableProcessors(),
        &quot;application.jvm.memory&quot; to format(&quot;%,d&quot;, heap.getInit() / 1024),
        &quot;application.jvm&quot; to getRuntimeMXBean().getVmName(),
        &quot;application.jvm.version&quot; to getRuntimeMXBean().getSpecVersion(),
        &quot;application.boot.time&quot; to format(&quot;%01.3f&quot;, bootTime / 1000f),
        &quot;application.used.memory&quot; to format(&quot;%,d&quot;, heap.getUsed() / 1024),
        &quot;application.host&quot; to hostName
    )

<span class="pc bpc" id="L64" title="1 of 2 branches missed.">    val banner = EOL + EOL + (read (&quot;banner.txt&quot;) ?: &quot;&quot;) + information</span>
<span class="fc" id="L65">        .replaceIndent(&quot; &quot;.repeat(4)).lines()</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        .map { if (it.isBlank()) it.trim() else it }</span>
<span class="fc" id="L67">        .joinToString(EOL) + EOL</span>

<span class="fc" id="L69">    RestPackage.info(banner.filterVars(variables))</span>
<span class="fc" id="L70">}</span>

fun read (resource: String) =
<span class="pc bpc" id="L73" title="5 of 6 branches missed.">    ClassLoader.getSystemClassLoader().getResourceAsStream(resource)?.reader()?.readText()</span>

fun appStart(cb: KServerSpec.() -&gt; Unit): RatpackServer {
<span class="fc" id="L76">    val server = RatpackServer.start { KServerSpec(it).(cb)() }</span>

    // TODO Setup metrics
<span class="fc" id="L79">    showBanner ()</span>

<span class="fc" id="L81">    return server</span>
}

fun &lt;T : Any, K : Any&gt; KChain.crud (repository: MongoIdRepository&lt;T, K&gt;): Chain {
<span class="nc" id="L85">    val collectionName = repository.namespace.collectionName</span>

<span class="nc" id="L87">    delegate.post (collectionName) { insert (repository, it) }</span>
<span class="nc" id="L88">    delegate.put (collectionName) { replace (repository, it) }</span>
<span class="nc" id="L89">    delegate.delete (collectionName + &quot;:id&quot;) { delete (repository, it) }</span>
<span class="nc" id="L90">    delegate.get (collectionName + &quot;:id&quot;) { find (repository, it) }</span>
<span class="nc" id="L91">    return delegate.get (collectionName) { findAll (repository, it) }</span>
}

private fun &lt;T : Any, K : Any&gt; insert (repository: MongoIdRepository&lt;T, K&gt;, handler: Context) {
<span class="nc" id="L95">    val obj = handler.request.body.toString().parse(repository.type)</span>
<span class="nc" id="L96">    try {</span>
<span class="nc" id="L97">        repository.insertOneObject(obj)</span>
<span class="nc" id="L98">        handler.response.status(201) // Created</span>
    }
    catch (e: MongoWriteException) {
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (e.error.code == 11000)</span>
<span class="nc" id="L102">            handler.response.status(500)//(UNPROCESSABLE_ENTITY)</span>
        else
<span class="nc" id="L104">            throw e</span>
    }
<span class="nc" id="L106">}</span>

private fun &lt;T : Any, K : Any&gt; replace (repository: MongoIdRepository&lt;T, K&gt;, handler: Context) {
<span class="nc" id="L109">    val obj = handler.request.body.toString ().parse(repository.type)</span>
<span class="nc" id="L110">    repository.replaceObject(obj)</span>
<span class="nc" id="L111">}</span>

private fun &lt;T : Any, K : Any&gt; delete (repository: MongoIdRepository&lt;T, K&gt;, handler: Context) {
<span class="nc bnc" id="L114" title="All 4 branches missed.">    val key = handler.pathTokens[&quot;id&quot;]?.parse (repository.keyType) ?: throw IllegalStateException ()</span>
<span class="nc" id="L115">    repository.deleteId(key)</span>
<span class="nc" id="L116">}</span>

private fun &lt;T : Any, K : Any&gt; find (repository: MongoIdRepository&lt;T, K&gt;, handler: Context) {
<span class="nc bnc" id="L119" title="All 4 branches missed.">    val key: K = handler.pathTokens[&quot;id&quot;]?.parse(repository.keyType) ?: throw IllegalStateException ()</span>
<span class="nc" id="L120">    val obj = repository.find(key)</span>

<span class="nc bnc" id="L122" title="All 2 branches missed.">    if (obj == null)</span>
<span class="nc" id="L123">        handler.response.status(404)//NOT_FOUND)</span>
    else
<span class="nc" id="L125">        handler.response.send(obj.serialize())</span>
<span class="nc" id="L126">}</span>

private fun &lt;T : Any, K : Any&gt; findAll (repository: MongoIdRepository&lt;T, K&gt;, handler: Context) {
<span class="nc" id="L129">    val objects = repository.findObjects().toList()</span>
<span class="nc" id="L130">    handler.response.send(objects.serialize())</span>
<span class="nc" id="L131">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>