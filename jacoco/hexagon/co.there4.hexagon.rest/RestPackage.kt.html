<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RestPackage.kt</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon</a> &gt; <a href="index.source.html" class="el_package">co.there4.hexagon.rest</a> &gt; <span class="el_source">RestPackage.kt</span></div><h1>RestPackage.kt</h1><pre class="source lang-java linenums">package co.there4.hexagon.rest

import co.there4.hexagon.configuration.ConfigManager
import co.there4.hexagon.repository.MongoIdRepository
import java.lang.Runtime.getRuntime
import java.lang.String.format
import java.lang.System.currentTimeMillis
import java.lang.System.getProperty
import java.lang.management.ManagementFactory.getMemoryMXBean
import java.lang.management.ManagementFactory.getRuntimeMXBean
import java.net.InetAddress.getByName as address

import co.there4.hexagon.util.*
import co.there4.hexagon.web.Server
import co.there4.hexagon.web.blacksheep
import co.there4.hexagon.web.jetty.JettyServer

/*
 * TODO Add base class for Application (setup locales, etc.) for web applications
 * TODO Add base class for Services (the setup for applications is not needed here)
 */
<span class="fc" id="L22">object RestPackage : CompanionLogger (RestPackage::class)</span>

<span class="pc" id="L24">val information = &quot;&quot;&quot;</span>
    SERVICE:     #{service.name}
    PACKAGE:     #{service.package}
    DIRECTORY:   #{service.dir}
    ENVIRONMENT: #{environment}

    Running in '#{application.host}' with #{application.cpus} CPUs #{application.jvm.memory} KB
    Java #{application.jvm.version} [#{application.jvm}]
    Locale #{application.locale} Timezone #{application.timezone}

    Started in #{application.boot.time} s using #{application.used.memory} KB
    &quot;&quot;&quot;

private fun showBanner() {
<span class="fc" id="L38">    val runtime = getRuntime()</span>
<span class="fc" id="L39">    val heap = getMemoryMXBean().getHeapMemoryUsage()</span>
<span class="fc" id="L40">    val bootTime = currentTimeMillis() - getRuntimeMXBean().getStartTime()</span>

<span class="fc" id="L42">    val locale = &quot;%s_%s.%s&quot;.format(</span>
        getProperty(&quot;user.language&quot;),
        getProperty(&quot;user.country&quot;),
        getProperty(&quot;file.encoding&quot;)
    )

<span class="pc bpc" id="L48" title="1 of 2 branches missed.">    val variables = mapOf (</span>
        &quot;service.name&quot; to ConfigManager.serviceName,
        &quot;service.dir&quot; to ConfigManager.serviceDir,
        &quot;service.package&quot; to ConfigManager.servicePackage,
        &quot;environment&quot; to (ConfigManager.environment ?: &quot;N/A&quot;),
        &quot;application.locale&quot; to locale,
        &quot;application.timezone&quot; to getProperty(&quot;user.timezone&quot;),
        &quot;application.cpus&quot; to runtime.availableProcessors(),
        &quot;application.jvm.memory&quot; to format(&quot;%,d&quot;, heap.getInit() / 1024),
        &quot;application.jvm&quot; to getRuntimeMXBean().getVmName(),
        &quot;application.jvm.version&quot; to getRuntimeMXBean().getSpecVersion(),
        &quot;application.boot.time&quot; to format(&quot;%01.3f&quot;, bootTime / 1000f),
        &quot;application.used.memory&quot; to format(&quot;%,d&quot;, heap.getUsed() / 1024),
        &quot;application.host&quot; to hostname
    )

<span class="pc bpc" id="L64" title="1 of 2 branches missed.">    val banner = EOL + EOL + (read (&quot;banner.txt&quot;) ?: &quot;&quot;) + information</span>
<span class="fc" id="L65">        .replaceIndent(&quot; &quot;.repeat(4)).lines()</span>
<span class="pc bpc" id="L66" title="1 of 4 branches missed.">        .map { if (it.isBlank()) it.trim() else it }</span>
<span class="fc" id="L67">        .joinToString(EOL) + EOL</span>

<span class="fc" id="L69">    RestPackage.info(banner.filterVars(variables))</span>
<span class="fc" id="L70">}</span>

fun applicationStart(cb: Server.() -&gt; Unit): Server {
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">    val bindPort = ConfigManager[&quot;bindPort&quot;] as Int? ?: 5050</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">    val bindAddress = address(ConfigManager[&quot;bindAddress&quot;] as String? ?: &quot;127.0.0.1&quot;)</span>

<span class="fc" id="L76">    val server = JettyServer (</span>
        bindPort = bindPort,
        bindAddress = bindAddress
    )

<span class="fc" id="L81">    server.(cb)()</span>
<span class="fc" id="L82">    server.run()</span>

    // TODO Setup metrics
<span class="fc" id="L85">    showBanner ()</span>

<span class="fc" id="L87">    return server</span>
}

fun &lt;T : Any, K : Any&gt; Server.crud (repository: MongoIdRepository&lt;T, K&gt;) {
<span class="fc" id="L91">    RestCrud (repository, this)</span>
<span class="fc" id="L92">}</span>

fun &lt;T : Any, K : Any&gt; crud (repository: MongoIdRepository&lt;T, K&gt;) {
<span class="nc" id="L95">    blacksheep.crud (repository)</span>
<span class="nc" id="L96">}</span>

// TODO Add initialization for applications and services
//class RestService
//class RestApplication
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>