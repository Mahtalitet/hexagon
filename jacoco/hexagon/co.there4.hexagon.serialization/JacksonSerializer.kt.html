<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JacksonSerializer.kt</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon</a> &gt; <a href="index.source.html" class="el_package">co.there4.hexagon.serialization</a> &gt; <span class="el_source">JacksonSerializer.kt</span></div><h1>JacksonSerializer.kt</h1><pre class="source lang-java linenums">package co.there4.hexagon.serialization

import co.there4.hexagon.serialization.SerializationFormat.*
import com.fasterxml.jackson.annotation.JsonInclude.Include.NON_EMPTY
import com.fasterxml.jackson.core.JsonGenerator
import com.fasterxml.jackson.core.JsonParser
import com.fasterxml.jackson.core.util.DefaultIndenter.SYSTEM_LINEFEED_INSTANCE
import com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES
import com.fasterxml.jackson.databind.PropertyNamingStrategy.SNAKE_CASE
import com.fasterxml.jackson.databind.SerializationFeature.FAIL_ON_EMPTY_BEANS

import com.fasterxml.jackson.core.util.DefaultPrettyPrinter
import com.fasterxml.jackson.databind.*
import com.fasterxml.jackson.databind.module.SimpleModule
import com.fasterxml.jackson.datatype.jdk8.Jdk8Module
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule
import com.fasterxml.jackson.module.kotlin.KotlinModule
import com.fasterxml.jackson.module.paramnames.ParameterNamesModule
import java.nio.ByteBuffer
import java.util.*
import kotlin.reflect.KClass

<span class="fc" id="L23">class JacksonSerializer : Serializer {</span>
<span class="pc" id="L24">    val MAPPER = createObjectMapper ()</span>
<span class="pc" id="L25">    val WRITER = createObjectWriter ()</span>

    fun createObjectMapper (): ObjectMapper {
<span class="fc" id="L28">        val byteBufferSerializer: JsonSerializer&lt;ByteBuffer&gt; =</span>
<span class="fc" id="L29">            object : JsonSerializer&lt;ByteBuffer&gt; () {</span>
                override fun serialize(
                    value: ByteBuffer, gen: JsonGenerator, serializers: SerializerProvider) {

<span class="fc" id="L33">                    gen.writeString (Base64.getEncoder ().encodeToString (value.array()))</span>
<span class="fc" id="L34">                }</span>
            }

<span class="fc" id="L37">        val byteBufferDeserializer: JsonDeserializer&lt;ByteBuffer&gt; =</span>
<span class="fc" id="L38">            object : JsonDeserializer&lt;ByteBuffer&gt; () {</span>
                override fun deserialize(p: JsonParser, ctxt: DeserializationContext): ByteBuffer =
<span class="fc" id="L40">                    ByteBuffer.wrap (Base64.getDecoder ().decode (p.getText ()))</span>
            }

<span class="fc" id="L43">        val mapper = ObjectMapper ()</span>
<span class="fc" id="L44">        mapper.configure (FAIL_ON_UNKNOWN_PROPERTIES, false)</span>
<span class="fc" id="L45">        mapper.configure (FAIL_ON_EMPTY_BEANS, false)</span>
<span class="fc" id="L46">        mapper.setSerializationInclusion (NON_EMPTY)</span>
<span class="fc" id="L47">        mapper.setPropertyNamingStrategy (SNAKE_CASE)</span>
<span class="fc" id="L48">        mapper.registerModule (Jdk8Module ())</span>
<span class="fc" id="L49">        mapper.registerModule (JavaTimeModule ())</span>
<span class="fc" id="L50">        mapper.registerModule (ParameterNamesModule ())</span>
<span class="fc" id="L51">        mapper.registerModule (KotlinModule ())</span>
<span class="fc" id="L52">        mapper.registerModule (object : SimpleModule () {</span>
            init {
<span class="fc" id="L54">                addSerializer (ByteBuffer::class.java, byteBufferSerializer)</span>
<span class="fc" id="L55">                addDeserializer (ByteBuffer::class.java, byteBufferDeserializer)</span>
            }
        })
<span class="fc" id="L58">        return mapper</span>
    }

    fun createObjectWriter (): ObjectWriter {
<span class="fc" id="L62">        val printer = DefaultPrettyPrinter ().withArrayIndenter (SYSTEM_LINEFEED_INSTANCE)</span>
<span class="fc" id="L63">        return MAPPER.writer (printer)</span>
    }

    override fun convertToMap(obj: Any): Map&lt;*, *&gt; =
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">        MAPPER.convertValue (obj, Map::class.java) ?: throw IllegalStateException ()</span>

<span class="fc" id="L69">    override fun &lt;T : Any&gt; convertToObject(obj: Map&lt;*, *&gt;, type: KClass&lt;T&gt;): T = MAPPER.convertValue (obj, type.java)</span>

<span class="fc" id="L71">    override fun serialize(format: SerializationFormat, obj: Any): String = when (format) {</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">        JSON -&gt; serializeJson (obj)</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        YAML -&gt; serializeYaml (obj)</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        XML -&gt; serializeXml (obj)</span>
<span class="fc" id="L75">    }</span>

    override fun &lt;T : Any&gt; parse(format: SerializationFormat, text: String, type: KClass&lt;T&gt;): T =
<span class="fc" id="L78">        when (format) {</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">            JSON -&gt; parseJson (text, type)</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            YAML -&gt; parseYaml (text, type)</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            XML -&gt; parseXml (text, type)</span>
<span class="fc" id="L82">        }</span>

    override fun &lt;T : Any&gt; parseList(format: SerializationFormat, text: String, type: KClass&lt;T&gt;) =
<span class="fc" id="L85">        when (format) {</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">            JSON -&gt; parseJsonList (text, type)</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            YAML -&gt; parseYamlList (text, type)</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">            XML -&gt; parseXmlList (text, type)</span>
<span class="fc" id="L89">        }</span>

<span class="fc" id="L91">    private fun serializeJson(obj: Any): String = WRITER.writeValueAsString (obj)</span>

    private fun &lt;T : Any&gt; parseJson(text: String, type: KClass&lt;T&gt;): T =
<span class="fc" id="L94">        MAPPER.readValue (text, type.java)</span>

    private fun &lt;T : Any&gt; parseJsonList(text: String, type: KClass&lt;T&gt;): List&lt;T&gt; {
<span class="fc" id="L97">        val t = MAPPER.getTypeFactory().constructCollectionType(List::class.java, type.java)</span>
<span class="fc" id="L98">        return MAPPER.readValue (text, t)</span>
    }

<span class="nc" id="L101">    private fun serializeXml(obj: Any): String = TODO()</span>
<span class="nc" id="L102">    private fun &lt;T: Any&gt; parseXml(text: String, type: KClass&lt;T&gt;): T = TODO()</span>
<span class="nc" id="L103">    private fun &lt;T: Any&gt; parseXmlList(text: String, type: KClass&lt;T&gt;): List&lt;T&gt; = TODO()</span>

<span class="nc" id="L105">    private fun serializeYaml(obj: Any): String = TODO()</span>
<span class="nc" id="L106">    private fun &lt;T: Any&gt; parseYaml(text: String, type: KClass&lt;T&gt;): T = TODO()</span>
<span class="nc" id="L107">    private fun &lt;T: Any&gt; parseYamlList(text: String, type: KClass&lt;T&gt;): List&lt;T&gt; = TODO()</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>