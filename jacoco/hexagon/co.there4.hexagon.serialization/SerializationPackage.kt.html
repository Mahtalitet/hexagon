<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SerializationPackage.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon</a> &gt; <a href="index.source.html" class="el_package">co.there4.hexagon.serialization</a> &gt; <span class="el_source">SerializationPackage.kt</span></div><h1>SerializationPackage.kt</h1><pre class="source lang-java linenums">package co.there4.hexagon.serialization

import co.there4.hexagon.util.resourceAsStream
import com.fasterxml.jackson.annotation.JsonInclude.Include.NON_EMPTY
import com.fasterxml.jackson.core.*
import com.fasterxml.jackson.core.JsonToken.START_OBJECT
import com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES
import com.fasterxml.jackson.databind.SerializationFeature.FAIL_ON_EMPTY_BEANS
import com.fasterxml.jackson.databind.*
import com.fasterxml.jackson.databind.deser.ContextualDeserializer
import com.fasterxml.jackson.databind.module.SimpleModule
import com.fasterxml.jackson.datatype.jdk8.Jdk8Module
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule
import com.fasterxml.jackson.module.kotlin.KotlinModule
import java.io.File

import java.io.InputStream
import java.nio.ByteBuffer
import java.time.LocalDate
import java.time.LocalTime
import java.util.*
import kotlin.reflect.KClass

<span class="fc" id="L24">val defaultFormat = JacksonSerializer.contentTypes.first()</span>

<span class="fc" id="L26">fun Any.convertToMap(): Map&lt;*, *&gt; = JacksonSerializer.toMap (this)</span>
<span class="fc" id="L27">fun &lt;T : Any&gt; Map&lt;*, *&gt;.convertToObject(type: KClass&lt;T&gt;): T = JacksonSerializer.toObject(this, type)</span>
fun &lt;T : Any&gt; List&lt;Map&lt;*, *&gt;&gt;.convertToObject(type: KClass&lt;T&gt;): List&lt;T&gt; =
<span class="fc" id="L29">    this.map { it: Map&lt;*, *&gt; -&gt; it.convertToObject(type) }</span>

fun Any.serialize (contentType: String = defaultFormat) =
<span class="fc" id="L32">    JacksonSerializer.serialize(this, contentType)</span>

fun &lt;T : Any&gt; String.parse (type: KClass&lt;T&gt;, contentType: String = defaultFormat) =
<span class="fc" id="L35">    JacksonSerializer.parse (this, type, contentType)</span>
fun &lt;T : Any&gt; String.parseList (type: KClass&lt;T&gt;, contentType: String = defaultFormat) =
<span class="fc" id="L37">    JacksonSerializer.parseList (this, type, contentType)</span>

fun &lt;T : Any&gt; InputStream.parse (type: KClass&lt;T&gt;, contentType: String = defaultFormat) =
<span class="fc" id="L40">    JacksonSerializer.parse (this, type, contentType)</span>
fun &lt;T : Any&gt; InputStream.parseList (type: KClass&lt;T&gt;, contentType: String = defaultFormat) =
<span class="fc" id="L42">    JacksonSerializer.parseList (this, type, contentType)</span>

<span class="fc" id="L44">fun String.parse (contentType: String = defaultFormat) = this.parse (Map::class, contentType)</span>
<span class="fc" id="L45">fun String.parseList(contentType: String = defaultFormat) = this.parseList (Map::class, contentType)</span>

<span class="nc" id="L47">fun InputStream.parse (contentType: String = defaultFormat) = this.parse (Map::class, contentType)</span>
fun InputStream.parseList (contentType: String = defaultFormat) =
<span class="nc" id="L49">    this.parseList (Map::class, contentType)</span>

fun &lt;T : Any&gt; File.parse (type: KClass&lt;T&gt;) =
<span class="fc" id="L52">    this.inputStream().parse (type, &quot;application/&quot; + this.extension)</span>
fun &lt;T : Any&gt; File.parseList (type: KClass&lt;T&gt;): List&lt;T&gt; =
<span class="fc" id="L54">    this.inputStream().parseList (type, &quot;application/&quot; + this.extension)</span>

<span class="fc" id="L56">fun File.parse () = this.parse (Map::class)</span>
<span class="fc" id="L57">fun File.parseList () = this.parseList (Map::class)</span>

fun &lt;T : Any&gt; resourceParse (path: String, type: KClass&lt;T&gt;) =
<span class="pc bpc" id="L60" title="2 of 4 branches missed.">    resourceAsStream(path)?.parse (type, &quot;application/&quot; + path.substringAfter(&quot;.&quot;, &quot;json&quot;)) ?: error(&quot;&quot;)</span>
fun &lt;T : Any&gt; resourceParseList (path: String, type: KClass&lt;T&gt;) =
<span class="pc bpc" id="L62" title="2 of 4 branches missed.">    resourceAsStream(path)?.parseList (type, &quot;application/&quot; + path.substringAfter(&quot;.&quot;, &quot;json&quot;)) ?: error(&quot;&quot;)</span>

<span class="fc" id="L64">fun resourceParse (path: String) = resourceParse(path, Map::class)</span>
<span class="fc" id="L65">fun resourceParseList (path: String) = resourceParseList(path, Map::class)</span>

internal fun createObjectMapper(mapperFactory: JsonFactory = MappingJsonFactory()): ObjectMapper {
<span class="fc" id="L68">    val mapper = ObjectMapper (mapperFactory)</span>
<span class="fc" id="L69">    mapper.configure (FAIL_ON_UNKNOWN_PROPERTIES, false)</span>
<span class="fc" id="L70">    mapper.configure (FAIL_ON_EMPTY_BEANS, false)</span>
<span class="fc" id="L71">    mapper.setSerializationInclusion (NON_EMPTY)</span>
<span class="fc" id="L72">    mapper.registerModule (Jdk8Module ())</span>
<span class="fc" id="L73">    mapper.registerModule (JavaTimeModule ())</span>
<span class="fc" id="L74">    mapper.registerModule (KotlinModule ())</span>
<span class="fc" id="L75">    mapper.registerModule (object : SimpleModule() {</span>
        init {
<span class="fc" id="L77">            addSerializer (ByteBuffer::class.java, ByteBufferSerializer)</span>
<span class="fc" id="L78">            addDeserializer (ByteBuffer::class.java, ByteBufferDeserializer)</span>
<span class="fc" id="L79">            addSerializer (LocalTime::class.java, LocalTimeSerializer)</span>
<span class="fc" id="L80">            addDeserializer (LocalTime::class.java, LocalTimeDeserializer)</span>
<span class="fc" id="L81">            addSerializer (LocalDate::class.java, LocalDateSerializer)</span>
<span class="fc" id="L82">            addDeserializer (LocalDate::class.java, LocalDateDeserializer)</span>
<span class="fc" id="L83">            addSerializer (ClosedRange::class.java, ClosedRangeSerializer)</span>
<span class="fc" id="L84">            addDeserializer (ClosedRange::class.java, ClosedRangeDeserializer)</span>
        }
    })
<span class="fc" id="L87">    return mapper</span>
}

<span class="fc" id="L90">internal object ByteBufferSerializer: JsonSerializer&lt;ByteBuffer&gt;() {</span>
    override fun serialize(value: ByteBuffer, gen: JsonGenerator, serializers: SerializerProvider) {
<span class="fc" id="L92">        gen.writeString (Base64.getEncoder ().encodeToString (value.array()))</span>
<span class="fc" id="L93">    }</span>
}

<span class="fc" id="L96">internal object ByteBufferDeserializer: JsonDeserializer&lt;ByteBuffer&gt;() {</span>
    override fun deserialize(p: JsonParser, ctxt: DeserializationContext): ByteBuffer =
<span class="fc" id="L98">        ByteBuffer.wrap (Base64.getDecoder ().decode (p.text))</span>
}

<span class="fc" id="L101">internal object LocalTimeSerializer: JsonSerializer&lt;LocalTime&gt; () {</span>
    override fun serialize(
        value: LocalTime, gen: JsonGenerator, serializers: SerializerProvider) {

<span class="fc" id="L105">        gen.writeStartArray()</span>
<span class="fc" id="L106">        gen.writeNumber(value.hour)</span>
<span class="fc" id="L107">        gen.writeNumber(value.minute)</span>
<span class="fc" id="L108">        gen.writeNumber(value.second)</span>
<span class="fc" id="L109">        gen.writeNumber(value.nano)</span>
<span class="fc" id="L110">        gen.writeEndArray()</span>
<span class="fc" id="L111">    }</span>
}

<span class="fc" id="L114">internal object LocalTimeDeserializer: JsonDeserializer&lt;LocalTime&gt; () {</span>
    override fun deserialize(p: JsonParser, ctxt: DeserializationContext): LocalTime {
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (p.currentToken != JsonToken.START_ARRAY)</span>
<span class="nc" id="L117">            error (&quot;Local time should start with an array&quot;)</span>
<span class="fc" id="L118">        val result = LocalTime.of(</span>
            p.nextIntValue(0),
            p.nextIntValue(0),
            p.nextIntValue(0),
            p.nextIntValue(0)
        )
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">        if (p.nextToken() != JsonToken.END_ARRAY)</span>
<span class="nc" id="L125">            error (&quot;Local time should end with an array&quot;)</span>
<span class="fc" id="L126">        return result</span>
    }
}

<span class="fc" id="L130">internal object LocalDateSerializer: JsonSerializer&lt;LocalDate&gt; () {</span>
    override fun serialize(
        value: LocalDate, gen: JsonGenerator, serializers: SerializerProvider) {

<span class="fc" id="L134">        gen.writeStartArray()</span>
<span class="fc" id="L135">        gen.writeNumber(value.year)</span>
<span class="fc" id="L136">        gen.writeNumber(value.monthValue)</span>
<span class="fc" id="L137">        gen.writeNumber(value.dayOfMonth)</span>
<span class="fc" id="L138">        gen.writeEndArray()</span>
<span class="fc" id="L139">    }</span>
}

<span class="fc" id="L142">internal object LocalDateDeserializer: JsonDeserializer&lt;LocalDate&gt; () {</span>
    override fun deserialize(p: JsonParser, ctxt: DeserializationContext): LocalDate {
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        if (p.currentToken != JsonToken.START_ARRAY)</span>
<span class="nc" id="L145">            error (&quot;Local date should start with an array&quot;)</span>
<span class="fc" id="L146">        val result = LocalDate.of(</span>
            p.nextIntValue(0),
            p.nextIntValue(0),
            p.nextIntValue(0)
        )
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if (p.nextToken() != JsonToken.END_ARRAY)</span>
<span class="nc" id="L152">            error (&quot;Local date should end with an array&quot;)</span>
<span class="fc" id="L153">        return result</span>
    }
}

<span class="fc" id="L157">internal object ClosedRangeSerializer: JsonSerializer&lt;ClosedRange&lt;*&gt;&gt; () {</span>
    override fun serialize(
        value: ClosedRange&lt;*&gt;, gen: JsonGenerator, serializers: SerializerProvider) {

<span class="fc" id="L161">        val start = value.start</span>
<span class="fc" id="L162">        val end = value.endInclusive</span>
<span class="fc" id="L163">        val valueSerializer = serializers.findValueSerializer(start.javaClass)</span>

<span class="fc" id="L165">        gen.writeStartObject()</span>

<span class="fc" id="L167">        gen.writeFieldName(&quot;start&quot;)</span>
<span class="fc" id="L168">        valueSerializer.serialize(start, gen, serializers)</span>

<span class="fc" id="L170">        gen.writeFieldName(&quot;endInclusive&quot;)</span>
<span class="fc" id="L171">        valueSerializer.serialize(end, gen, serializers)</span>

<span class="fc" id="L173">        gen.writeEndObject()</span>
<span class="fc" id="L174">    }</span>
}

<span class="fc" id="L177">internal object ClosedRangeDeserializer: JsonDeserializer&lt;ClosedRange&lt;*&gt;&gt; (), ContextualDeserializer {</span>
<span class="pc" id="L178">    private val valueType: ThreadLocal&lt;JavaType?&gt; = ThreadLocal.withInitial { null }</span>

    override fun createContextual(
        ctxt: DeserializationContext, property: BeanProperty): JsonDeserializer&lt;*&gt; {

<span class="fc" id="L183">        valueType.set(property.type.containedType(0))</span>
<span class="fc" id="L184">        return ClosedRangeDeserializer</span>
    }

    override fun deserialize(p: JsonParser, ctxt: DeserializationContext): ClosedRange&lt;*&gt; {
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if (p.currentToken != START_OBJECT)</span>
<span class="nc" id="L189">            error (&quot;Closed range should be an object&quot;)</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        check(p.nextFieldName() == &quot;start&quot;) { &quot;Ranges should start with 'start' field&quot; }</span>
<span class="fc" id="L191">        p.nextToken() // Start object</span>
<span class="fc" id="L192">        val type = valueType.get()</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        @Suppress(&quot;UNCHECKED_CAST&quot;) val start = ctxt.readValue&lt;Any&gt;(p, type) as Comparable&lt;Any&gt;</span>
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        check(p.nextFieldName() == &quot;endInclusive&quot;) { &quot;Ranges should end with 'endInclusive' field&quot; }</span>
<span class="fc" id="L195">        p.nextToken() // End array</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">        @Suppress(&quot;UNCHECKED_CAST&quot;) val end = ctxt.readValue&lt;Any&gt;(p, type) as Comparable&lt;Any&gt;</span>
<span class="fc" id="L197">        p.nextToken() // End array</span>
<span class="fc" id="L198">        return start .. end</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>