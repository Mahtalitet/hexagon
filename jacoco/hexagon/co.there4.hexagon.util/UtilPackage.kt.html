<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UtilPackage.kt</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon</a> &gt; <a href="index.source.html" class="el_package">co.there4.hexagon.util</a> &gt; <span class="el_source">UtilPackage.kt</span></div><h1>UtilPackage.kt</h1><pre class="source lang-java linenums">package co.there4.hexagon.util

import java.lang.System.*
import java.lang.ThreadLocal.withInitial
import java.net.InetAddress.getLocalHost
import java.time.LocalDateTime
import java.util.*

/*
 * Timing
 */

<span class="fc" id="L13">private val times = withInitial { LinkedList&lt;Long&gt; () }</span>

/**
 * Store a timestamp in nanoseconds in the thread's times stack.
 */
<span class="fc" id="L18">fun resetTimes() = times.get ().clear()</span>
/**
 * Store a timestamp in nanoseconds in the thread's times stack.
 */
<span class="fc" id="L22">fun pushTime() = times.get ().push(nanoTime())</span>
/**
 * Pop latest timestamp in the nanos times stack and returns the difference with current one.
 */
<span class="fc" id="L26">fun popTime() = nanoTime() - times.get().pop()</span>
/**
 * Returns a time difference in nanoseconds formatted as a string.
 */
<span class="fc" id="L30">fun formatTime(timestamp: Long) = &quot;%1.3f ms&quot;.format (timestamp / 1e6)</span>

/**
 * Formats a date as a formatted integer with this format: `YYYYMMDDHHmmss`.
 */
fun LocalDateTime.asInt () =
<span class="fc" id="L36">    (this.year       * 1e10.toLong()) +</span>
<span class="fc" id="L37">    (this.monthValue * 1e8.toLong()) +</span>
<span class="fc" id="L38">    (this.dayOfMonth * 1e6.toLong()) +</span>
<span class="fc" id="L39">    (this.hour       * 1e4.toLong()) +</span>
<span class="fc" id="L40">    (this.minute     * 1e2.toLong()) +</span>
<span class="fc" id="L41">    this.second</span>

/*
 * Threading
 */

/** Map for storing context data linked to the executing thread. */
<span class="fc" id="L48">object Context {</span>
<span class="fc" id="L49">    private val threadLocal = withInitial { LinkedHashMap&lt;Any, Any&gt;() }</span>
<span class="fc" id="L50">    fun entries () = threadLocal.get().entries</span>
<span class="fc" id="L51">    operator fun get (key: Any) = threadLocal.get()[key]</span>
<span class="fc" id="L52">    operator fun set (key: Any, value: Any) { threadLocal.get()[key] = value }</span>
}

/**
 * Executes a lambda until no exception is thrown or a number of times is reached.
 *
 * @param times Number of times to try to execute the callback. Must be greater than 0.
 * @param delay Milliseconds to wait to next execution if there was an error. Must be 0 or greater.
 * @return The callback result if succeed.
 * @throws [ProgramException] if the callback didn't succeed in the given times.
 */
fun &lt;T&gt; retry (times: Int, delay: Long, func: () -&gt; T): T {
<span class="fc bfc" id="L64" title="All 2 branches covered.">    require (times &gt; 0)</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">    require (delay &gt;= 0)</span>

<span class="fc" id="L67">    val exceptions = mutableListOf&lt;Exception&gt;()</span>
<span class="pc bpc" id="L68" title="1 of 4 branches missed.">    for (ii in 1 .. times) {</span>
<span class="fc" id="L69">        try {</span>
<span class="fc" id="L70">            return func ()</span>
        }
        catch (e: Exception) {
<span class="fc" id="L73">            exceptions.add (e)</span>
<span class="fc" id="L74">            Thread.sleep (delay)</span>
        }
    }

<span class="fc" id="L78">    throw ProgramException(0, &quot;Error retrying $times times ($delay ms)&quot;, *exceptions.toTypedArray())</span>
}

/*
 * Networking
 */

/** Unknown host name. */
<span class="fc" id="L86">val UNKNOWN_LOCALHOST = &quot;UNKNOWN_LOCALHOST&quot;</span>

/** The hostname of the machine running this program. */
<span class="pc bpc" id="L89" title="2 of 4 branches missed.">val hostname = getLocalHost()?.getHostName() ?: UNKNOWN_LOCALHOST</span>
/** The IP address of the machine running this program. */
<span class="pc bpc" id="L91" title="2 of 4 branches missed.">val ip = getLocalHost()?.getHostAddress() ?: UNKNOWN_LOCALHOST</span>

/*
 * Error handling
 */

/**
 * Returns the stack trace array of the frames that starts with the given prefix.
 */
fun Throwable.filterStackTrace (prefix: String) =
<span class="fc" id="L101">    if (prefix.isEmpty ())</span>
<span class="fc" id="L102">        this.stackTrace</span>
    else
<span class="fc bfc" id="L104" title="All 2 branches covered.">        this.stackTrace.filter { it.className.startsWith (prefix) }.toTypedArray()</span>

/**
 * Returns this throwable as a text.
 */
fun Throwable.toText (prefix: String = &quot;&quot;): String =
<span class="fc" id="L110">    &quot;${this.javaClass.name}: ${this.message}&quot; +</span>
<span class="fc" id="L111">        this.filterStackTrace(prefix).map { &quot;\tat ${it.toString()}&quot; }.joinToString(EOL, EOL) +</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (this.cause == null)</span>
<span class="fc" id="L113">            &quot;&quot;</span>
        else
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">            &quot;${EOL}Caused by: &quot; + (this.cause as Throwable).toText (prefix)</span>

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>