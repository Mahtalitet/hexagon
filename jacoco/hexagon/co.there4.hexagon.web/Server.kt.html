<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Server.kt</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon</a> &gt; <a href="index.source.html" class="el_package">co.there4.hexagon.web</a> &gt; <span class="el_source">Server.kt</span></div><h1>Server.kt</h1><pre class="source lang-java linenums">package co.there4.hexagon.web

import java.net.InetAddress
import java.lang.System.*
import java.lang.Runtime.*
import co.there4.hexagon.util.CompanionLogger
import co.there4.hexagon.util.filter
import java.io.File
import java.lang.Thread.currentThread
import java.lang.management.ManagementFactory.*
import java.net.UnknownHostException
import java.util.*
import kotlin.reflect.KClass

<span class="fc" id="L15">abstract class Server (</span>
<span class="fc" id="L16">    val bindAddress: InetAddress = InetAddress.getLocalHost(),</span>
<span class="fc" id="L17">    val bindPort: Int = 4321,</span>

<span class="nc" id="L19">    val keystore: String? = null,</span>
<span class="nc" id="L20">    val keystorePassword: String? = null,</span>
<span class="nc" id="L21">    val truststore: String? = null,</span>
<span class="pc" id="L22">    val truststorePassword: String? = null) : Router() {</span>

<span class="fc" id="L24">    companion object : CompanionLogger (Server::class) {</span>
<span class="pc" id="L25">        val BASE_DIR = File (Server::class.java.protectionDomain.codeSource.location.toURI())</span>
    }

<span class="fc" id="L28">    val assets: MutableList&lt;String&gt; = ArrayList ()</span>
<span class="fc" id="L29">    val errors: MutableMap&lt;Class&lt;out Exception&gt;, Exchange.(e: Exception) -&gt; Unit&gt; = LinkedHashMap ()</span>

    /** Name of the application. Used for logging and configuration. */
<span class="fc" id="L32">    private val packageName = javaClass.`package`.name</span>
<span class="nc" id="L33">    val name =</span>
<span class="pc bpc" id="L34" title="1 of 2 branches missed.">        if (packageName.startsWith(&quot;co.there4.hexagon.http&quot;)) &quot;Blacksheep&quot;</span>
<span class="fc" id="L35">        else javaClass.simpleName</span>

    abstract fun started (): Boolean

    fun handleException (exception: Exception, exchange: Exchange) =
<span class="pc bpc" id="L40" title="1 of 2 branches missed.">            exchange.(errors[exception.javaClass] ?: { throw exception })(exception)</span>

<span class="fc" id="L42">    fun assets (path: String) = assets.add (path)</span>

    fun error(exception: Class&lt;out Exception&gt;, callback: Exchange.(e: Exception) -&gt; Unit) =
<span class="fc" id="L45">            errors.put (exception, callback)</span>

    fun error(exception: KClass&lt;out Exception&gt;, callback: Exchange.(e: Exception) -&gt; Unit) =
<span class="fc" id="L48">            error (exception.java, callback)</span>

<span class="nc" id="L50">    fun notFound () {}</span>
    fun internalError (callback: Exchange.(e: Exception) -&gt; Unit) =
<span class="nc" id="L52">        error (Exception::class, callback)</span>

    fun run() {
<span class="fc" id="L55">        getRuntime().addShutdownHook(</span>
            Thread (
                {
<span class="fc bfc" id="L58" title="All 2 branches covered.">                    if (started ())</span>
<span class="fc" id="L59">                        shutdown ()</span>
                    /*
                    try {
                        if (started)
                            stop ()
                    }
                    catch (e: Exception) {
                        // It could be trying to stop an already closed server (TODO FIX)
                    }
                    */
<span class="fc" id="L69">                },</span>
                &quot;shutdown-${bindAddress.hostName}-$bindPort&quot;
            )
        )

<span class="fc" id="L74">        startup ()</span>
<span class="fc" id="L75">        info (&quot;$name started${createBanner()}&quot;)</span>
<span class="fc" id="L76">    }</span>

    private fun createBanner(): String {
<span class="fc" id="L79">        val bannerResource = currentThread().contextClassLoader.getResourceAsStream(&quot;banner.txt&quot;)</span>
<span class="pc bpc" id="L80" title="7 of 8 branches missed.">        val bannerTemplate = bannerResource?.reader()?.readText() ?: &quot;&quot;</span>

<span class="fc" id="L82">        val rt = getRuntime ()</span>
<span class="fc" id="L83">        val heap = getMemoryMXBean ().heapMemoryUsage</span>
<span class="fc" id="L84">        val bootTime = currentTimeMillis () - getRuntimeMXBean ().startTime</span>
<span class="fc" id="L85">        val host =</span>
<span class="fc" id="L86">            try { InetAddress.getLocalHost ().canonicalHostName }</span>
<span class="nc" id="L87">            catch (e: UnknownHostException) { &quot;UNKNOWN&quot; }</span>

<span class="pc bpc" id="L89" title="2 of 4 branches missed.">        return bannerTemplate.filter(&quot;\${&quot;, &quot;}&quot;,</span>
            Pair (&quot;blacksheep.backend&quot;, javaClass.simpleName),
            Pair (&quot;blacksheep.bind&quot;, bindAddress.hostName),
            Pair (&quot;blacksheep.port&quot;, bindPort.toString ()),
            Pair (&quot;blacksheep.keystore.file&quot;, keystore ?: &quot;&quot;),
            Pair (&quot;blacksheep.truststore.file&quot;, truststore ?: &quot;&quot;),
            Pair (&quot;blacksheep.host&quot;, host),
            Pair (&quot;blacksheep.cpus&quot;, rt.availableProcessors ().toString ()),
            Pair (&quot;blacksheep.jvm.memory&quot;, &quot;%,d&quot;.format (heap.init shr 10)),
            Pair (&quot;blacksheep.jvm&quot;, getRuntimeMXBean ().vmName),
            Pair (&quot;blacksheep.jvm.version&quot;, getRuntimeMXBean ().specVersion),
            Pair (&quot;blacksheep.boot.time&quot;, &quot;%01.3f&quot;.format (bootTime / 1000f)),
            Pair (&quot;blacksheep.used.memory&quot;, &quot;%,d&quot;.format (heap.used shr 10))
        )
    }

    fun stop() {
<span class="fc" id="L106">        shutdown ()</span>
<span class="fc" id="L107">        info (&quot;$name stopped&quot;)</span>
<span class="fc" id="L108">    }</span>

    /**
     * Builds a server of a certain backend from a server definition and runs it.
     */
    protected abstract fun startup()

    /**
     * Stops the instance of the backend.
     */
    protected abstract fun shutdown()
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>