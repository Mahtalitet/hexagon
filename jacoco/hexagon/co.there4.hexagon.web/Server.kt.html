<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Server.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hexagon</a> &gt; <a href="index.source.html" class="el_package">co.there4.hexagon.web</a> &gt; <span class="el_source">Server.kt</span></div><h1>Server.kt</h1><pre class="source lang-java linenums">package co.there4.hexagon.web

import co.there4.hexagon.settings.SettingsManager
import co.there4.hexagon.util.*
import java.net.InetAddress
import java.lang.System.*
import java.lang.Runtime.*
import java.lang.management.ManagementFactory.*

<span class="fc" id="L10">abstract class Server (</span>
<span class="fc" id="L11">    val bindAddress: InetAddress = InetAddress.getByName(&quot;localhost&quot;),</span>
<span class="pc" id="L12">    val bindPort: Int = 2010) : Router() {</span>

<span class="fc" id="L14">    companion object : CompanionLogger (Server::class)</span>

<span class="pc bpc" id="L16" title="1 of 2 branches missed.">    val serviceName = SettingsManager[&quot;serviceName&quot;] ?: &quot;Hexagon&quot;</span>

<span class="pc" id="L18">open val runtimePort = bindPort</span>

    abstract fun started (): Boolean

    /**
     * Builds a server of a certain backend from a server definition and runs it.
     */
    protected abstract fun startup()

    /**
     * Stops the instance of the backend.
     */
    protected abstract fun shutdown()

    fun run() {
<span class="fc" id="L33">        getRuntime().addShutdownHook(</span>
            Thread (
                {
<span class="pc bpc" id="L36" title="1 of 2 branches missed.">                    if (started ())</span>
<span class="nc" id="L37">                        shutdown ()</span>
<span class="fc" id="L38">                },</span>
                &quot;shutdown-${bindAddress.hostName}-$bindPort&quot;
            )
        )

<span class="fc" id="L43">        startup ()</span>
<span class="fc" id="L44">        info (&quot;$serviceName started${createBanner()}&quot;)</span>
<span class="fc" id="L45">    }</span>

    fun stop() {
<span class="fc" id="L48">        shutdown ()</span>
<span class="fc" id="L49">        info (&quot;$serviceName stopped&quot;)</span>
<span class="fc" id="L50">    }</span>

    private fun createBanner(): String {
<span class="fc" id="L53">        val runtime = getRuntime()</span>
<span class="fc" id="L54">        val heap = getMemoryMXBean().heapMemoryUsage</span>
<span class="fc" id="L55">        val bootTime = currentTimeMillis() - getRuntimeMXBean().startTime</span>

<span class="fc" id="L57">        val locale = &quot;%s_%s.%s&quot;.format(</span>
            getProperty(&quot;user.language&quot;),
            getProperty(&quot;user.country&quot;),
            getProperty(&quot;file.encoding&quot;)
        )

<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        val environment = (SettingsManager.environment ?: &quot;N/A&quot;)</span>
<span class="fc" id="L64">        val applicationLocale = locale</span>
<span class="fc" id="L65">        val applicationTimezone = getProperty(&quot;user.timezone&quot;)</span>
<span class="fc" id="L66">        val applicationCpus = runtime.availableProcessors()</span>
<span class="fc" id="L67">        val applicationJvmMemory = String.format(&quot;%,d&quot;, heap.init / 1024)</span>
<span class="fc" id="L68">        val applicationJvm = getRuntimeMXBean().vmName</span>
<span class="fc" id="L69">        val applicationJvmVersion = getRuntimeMXBean().specVersion</span>
<span class="fc" id="L70">        val applicationBootTime = String.format(&quot;%01.3f&quot;, bootTime / 1e3)</span>
<span class="fc" id="L71">        val applicationUsedMemory = String.format(&quot;%,d&quot;, heap.used / 1024)</span>
<span class="fc" id="L72">        val applicationHost = hostname</span>

<span class="fc" id="L74">        val information = &quot;&quot;&quot;</span>
<span class="fc" id="L75">            SERVICE:     $serviceName</span>
<span class="fc" id="L76">            ENVIRONMENT: $environment</span>

<span class="fc" id="L78">            Running in '$applicationHost' with $applicationCpus CPUs $applicationJvmMemory KB</span>
<span class="fc" id="L79">            Java $applicationJvmVersion [$applicationJvm]</span>
<span class="fc" id="L80">            Locale $applicationLocale Timezone $applicationTimezone</span>

<span class="fc" id="L82">            Started in $applicationBootTime s using $applicationUsedMemory KB</span>
<span class="fc" id="L83">            Served at http://${bindAddress.canonicalHostName}:$runtimePort</span>
        &quot;&quot;&quot;

<span class="pc bpc" id="L86" title="1 of 2 branches missed.">        val banner = EOL + EOL + (readResource(&quot;banner.txt&quot;) ?: &quot;&quot;) + information</span>
<span class="fc" id="L87">            .replaceIndent(&quot; &quot;.repeat(4)).lines()</span>
<span class="pc bpc" id="L88" title="1 of 4 branches missed.">            .map { if (it.isBlank()) it.trim() else it }</span>
<span class="fc" id="L89">            .joinToString(EOL) + EOL</span>

<span class="fc" id="L91">        return banner</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>